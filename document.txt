*** Altera√ß√µes dia 01/08/2025 - 17:53 ***
Alterei o n√∫mero do telefone whatsapp no arquivo "layout.html"
Alterei o arquivo app.py para incluir o dotenv para seguran√ßa envio e-mail 
Crie o arquivo .env com e-mail e senha

Criei Flask-SQLAlchemy em 04/10/2025
pip install Flask Flask-SQLAlchemy psycopg2-binary python-dotenv

app.py anterior:
# === Inicializando SQLAlchemy ===
# db = SQLAlchemy(app)  # j√° inicializa com o app, sem precisar do db.init_app

# incluso anterior
#app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('DATABASE_URL')  # Exemplo: postgresql://user:pass@host/dbname
#app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

# defini√ß√£o da tabela product
class Product(db.Model):
    __tablename__ = 'product'
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    price = db.Column(db.Float, nullable=False)
    stock = db.Column(db.Integer, nullable=False)

class Product(db.Model):
    __tablename__ = 'product'
    id = db.Column(db.Integer, primary_key=True)
    type_id = db.Column(db.Integer, nullable=True)
    name = db.Column(db.String(80), nullable=False)
    price = db.Column(db.Numeric(10,2), nullable=False)
    discount = db.Column(db.Integer, default=0)
    stock = db.Column(db.Integer, nullable=False)
    colors = db.Column(db.Text, nullable=False)
    discription = db.Column(db.Text, nullable=False)
    pub_date = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)

    brand_id = db.Column(db.Integer, db.ForeignKey('brand.id'), nullable=False)
    marca = db.relationship('Brand', backref=db.backref('marcas', lazy=True))

    category_id = db.Column(db.Integer, db.ForeignKey('category.id'), nullable=False)
    categoria = db.relationship('Category', backref=db.backref('categorias', lazy=True))

    image_1 = db.Column(db.String(150), nullable=False, default='image.jpg')
    image_2 = db.Column(db.String(150), nullable=False, default='image.jpg')
    image_3 = db.Column(db.String(150), nullable=False, default='image.jpg')

    color_id = db.Column(db.Integer, db.ForeignKey('color.id'), nullable=False)
    cor = db.relationship('Color', backref=db.backref('cores', lazy=True))

    size_id = db.Column(db.Integer, db.ForeignKey('size.id'), nullable=False)
    nmsize = db.relationship('Size', backref=db.backref('sizes', lazy=True))
    tamanho = db.relationship('Size', backref=db.backref('tamanhos', lazy=True))
    packaging_id = db.Column(db.Integer, db.ForeignKey('packaging.id'), nullable=False)
    embalagem = db.relationship('Packaging', backref=db.backref('embalagens', lazy=True))

    store_id = db.Column(db.Integer, db.ForeignKey('store.id'), nullable=False)
    loja = db.relationship('Store', backref=db.backref('lojas.produto', lazy=True))
    type_id = db.Column(db.Integer, nullable=False)    

product_list.html:
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Admin - Lista de Produtos</title>
</head>
<body>
    <h1>Lista de Produtos</h1>
    <table border="1" cellpadding="8">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Pre√ßo (R$)</th>
                <th>Estoque</th>
            </tr>
        </thead>
        <tbody>
            {% for p in products %}
            <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.name }}</td>
                <td>{{ "%.2f"|format(p.price) }}</td>
                <td>{{ p.stock }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>

routes:
@admin_bp.route('/')
def product_list():
    products = Product.query.all()
    return render_template('admin/product_list.html', products=products)


# =========================================================
# FLUXO DE CADASTRO DE CLIENTE MULTI-STEP
# =========================================================

# ROTA 1.1: CADASTRO DE CLIENTE (PF/PJ)
@client_bp.route('/cliente/cadastrar', methods=['GET', 'POST'])
def client_register_fjpj():
    # ‚úÖ Usa o formul√°rio renomeado
    form = FormClientPFJ()
    
    if form.validate_on_submit():
        try:
            # 1. Determinar o tipo (F√≠sica 'F' ou Jur√≠dica 'J')
            code_data = ''.join(filter(str.isdigit, form.code.data))
            client_type = 'F' if len(code_data) == 11 else 'J'
            
            # 2. Armazenar dados b√°sicos na session para o pr√≥ximo passo
            session['client_reg_data'] = { # ‚úÖ Usa chave mais clara
                'code': code_data, 
                'name': form.name.data,
                'contact': form.contact.data, 
                'email': form.email.data,
                'type': client_type
            }
            
            # 3. Redirecionar para o passo 2 (Endere√ßo)
            return redirect(url_for('client_bp.client_register_address'))

        except Exception as e:
            flash(f'Erro interno ao processar dados. {e}', 'danger')
            
    # ‚úÖ Renderiza o template de cadastro inicial (NOME PROFISSIONALIZADO)
    return render_template('client/client_create_personal_data.html', form=form, titulo="Registrar Novo Cliente", stperson="active")

# ROTA 1.2: CADASTRO DE CLIENTE (DIVERSOS)
@client_bp.route('/cliente/diversos', methods=['GET', 'POST'])
def client_register_div():
    # ‚úÖ Usa o formul√°rio renomeado
    form = FormClientDiv()
    
    if form.validate_on_submit():
        # 1. Armazenar dados b√°sicos na session (Type 'D')
        session['client_reg_data'] = { # ‚úÖ Usa chave mais clara
            'code': form.code.data, 
            'name': form.name.data,
            'contact': form.contact.data, 
            'email': form.email.data,
            'type': 'D' # Cliente Diversos
        }
        
        # 2. Redirecionar para o passo 2 (Endere√ßo)
        return redirect(url_for('client_bp.client_register_address'))

    # ‚úÖ Renderiza o template de cadastro diverso (NOME PROFISSIONALIZADO)
    # Assumindo que o template √© o mesmo da primeira etapa, com o form diferente.
    return render_template('client/client_create_personal_data.html', form=form, titulo="Cadastrar Cliente Diversos", stperson="active")


# ROTA 2: CADASTRO DE CLIENTE - ENDERE√áO
@client_bp.route('/cliente/endereco', methods=['GET'])
def client_register_address():
    # 1. Verificar se o Passo 1 foi conclu√≠do
    if 'client_reg_data' not in session:
        flash('Por favor, preencha os dados b√°sicos antes de prosseguir.', 'warning')
        return redirect(url_for('client_bp.client_register_fjpj')) 

    # ‚úÖ Usa o formul√°rio renomeado (Endere√ßo)
    form = FormClientAddress()

    # O submit deste formul√°rio deve ir para a rota client_save
    # ‚úÖ Renderiza o template de endere√ßo (NOME PROFISSIONALIZADO)
    return render_template('client/client_create_address.html', form=form, titulo="Registrar Novo Cliente - Endere√ßo (Passo 2 de 2)", stperson="active")

# -------------------------
        # üîπ Gera√ß√£o da chave de acesso din√¢mica
        # -------------------------
        store_data = session.get('Store', {})
        uf_map = {
            'AC': '12', 'AL': '27', 'AP': '16', 'AM': '13', 'BA': '29',
            'CE': '23', 'DF': '53', 'ES': '32', 'GO': '52', 'MA': '21',
            'MT': '51', 'MS': '50', 'MG': '31', 'PA': '15', 'PB': '25',
            'PR': '41', 'PE': '26', 'PI': '22', 'RJ': '33', 'RN': '24',
            'RS': '43', 'RO': '11', 'RR': '14', 'SC': '42', 'SP': '35',
            'SE': '28', 'TO': '17'
        }

        region = store_data.get('Region', 'SC')
        uf_code = uf_map.get(region.upper(), '42')  # padr√£o SC

        # ‚ö†Ô∏è Certifique-se que o campo correto com CNPJ existe
        cnpj_loja = store_data.get('Code', '00000000000000')  # substitua por stores.cnpj se existir
        cnpj_numerico = ''.join(filter(str.isdigit, cnpj_loja))[:14].ljust(14, '0')

        number = datetime.now().strftime('%Y%m%d%H%M%S')
        codigo_numerico = randint(100000000, 999999999)  

 @nfe_bp.route('/gerar-xml-nfce/<int:id>')
def gerar_xml_nfce(id):

    invoice = Invoice.query.get_or_404(id)


    if not invoice.number or invoice.number > 999999999:
        raise Exception("N√∫mero da NF inv√°lido (nNF deve ter at√© 9 d√≠gitos)")

    client = invoice.client
    items = invoice.items

    # üîê Dados do emitente via STORE (sess√£o)
    store = session.get("Store")
    if not store:
        raise Exception("Dados da loja (STORE) n√£o encontrados na sess√£o")

    emitente = {
        "code": store["Code"],
        "name": store["Name"],
        "state_registration": store["State_Registration"],
        "crt": store["CRT"],
        "address": {
            "xLgr": store["Address"],
            "nro": store["Number"],
            "xBairro": store["Neighborhood"],
            "cMun": IBGE_CITY_CODE,      # config.py
            "xMun": store["City"],
            "UF": store["UF"],
            "CEP": store["ZipCode"],
            "cPais": "1058",
            "xPais": "Brasil"
        }
    }

    # üîó QRCode (se j√° existir fun√ß√£o)
    digest_value = ""  # ainda vazio antes da assinatura
    qrcode_url = gerar_qrcode_url(
        chave=invoice.access_key,
        valor_nf=invoice.total_value,
        digest_value=digest_value
    )


    # üßæ Gera√ß√£o do XML
    xml_bytes = gerar_xml_nfce(
        invoice=invoice,
        client=client,
        items=items,
        emitente=emitente,
        qrcode_url=qrcode_url,
        tp_amb=TP_AMB
    )

    # üíæ Salva XML
    xml_name = f"NFCe_{invoice.access_key}.xml"
    xml_path = f"admin/nfe/output/{xml_name}"

    with open(xml_path, "wb") as f:
        f.write(xml_bytes)

    invoice.xml_path = xml_path
    invoice.status = "X"
    db.session.commit()

    flash("Gera√ß√£o do XML NFC-e conclu√≠da com sucesso!", "success")
    return redirect(url_for("nfe_bp.nfe_list"))
       
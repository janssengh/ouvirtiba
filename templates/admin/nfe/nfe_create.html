{% extends "layout_admin.html" %}

{% block content %}

{% include 'navbar_admin.html' %}
<div class="container mt-4">
  <h3>{{ titulo }}</h3>
  <hr>
  <form method="post">
    <div class="mb-3">
      <label class="form-label">Pedido Relacionado (opcional)</label>
      <select name="order_id" id="order_id" class="form-select">
        <option value="">-- Nenhum --</option>
        {% for o in orders %}
        <option value="{{ o.id }}" data-amount="{{ o.amount }}" data-client-id="{{ o.client_id }}" data-client-name="{{ o.client.name }}">Pedido #{{ o.number }} - {{ o.client.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Cliente</label>
      <input type="text" id="client_name_display" class="form-control" disabled>
      <input type="hidden" name="client_id" id="client_id_hidden" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Valor Total (R$)</label>
      <input type="number" step="0.01" name="total_value" id="total_value" class="form-control" required>
    </div>
    
    <button type="submit" class="btn btn-primary">Salvar Nota Fiscal</button>
    <a href="{{ url_for('nfe_bp.nfe_list') }}" class="btn btn-secondary">Cancelar</a>
  </form>
</div>

<script>
  const orderSelect = document.getElementById('order_id');
  const totalValueInput = document.getElementById('total_value');
  const clientNameDisplay = document.getElementById('client_name_display'); // Novo elemento de exibição
  const clientIdHidden = document.getElementById('client_id_hidden'); // Novo campo hidden para o ID

  orderSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const amount = selectedOption.getAttribute('data-amount');
    const clientId = selectedOption.getAttribute('data-client-id');
    const clientName = selectedOption.getAttribute('data-client-name'); // Pega o nome do cliente

    // 1. Atualiza o Valor Total
    if (amount) {
      totalValueInput.value = parseFloat(amount).toFixed(2);
      totalValueInput.readOnly = true;
    } else {
      totalValueInput.value = '';
      totalValueInput.readOnly = false;
    }

    // 2. Atualiza o Cliente
    if (clientId && clientName) {
      clientNameDisplay.value = clientName; // Exibe o nome
      clientIdHidden.value = clientId; // Define o ID no campo hidden
      clientIdHidden.setAttribute('required', 'required'); // Garante que o ID é enviado
    } else {
      clientNameDisplay.value = '';
      clientIdHidden.value = '';
      // Se não houver pedido, a nota fiscal deve ser criada sem cliente ou
      // exigindo que o usuário selecione um cliente de outra forma. 
      // Manter como required força a seleção de um pedido.
      // Ajuste: Se o pedido é opcional, o cliente deve ser obrigatório.
      // Como a lógica original não permitia nota sem cliente, 
      // faremos com que a seleção do pedido seja a única forma de preencher o cliente.
      clientIdHidden.removeAttribute('required'); 
    }
  });
  
  // Opcional: Para manter o cliente desabilitado/preenchido se a página for recarregada com o POST
  document.addEventListener('DOMContentLoaded', function() {
    if (orderSelect.value !== '') {
      orderSelect.dispatchEvent(new Event('change'));
    }
  });
</script>

{% endblock %}